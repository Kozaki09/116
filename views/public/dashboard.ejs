<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/general.css"> <!-- General styles -->
    <link rel="stylesheet" href="/css/dashboard.css"> <!-- Specific styles for dashboard page -->
    <link rel="stylesheet" href="/css/sidebar.css"> <!-- Specific styles for login/create page -->
    <link rel="stylesheet" href="/css/modal.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div id="sidebar-container"><%- include('../partials/sidebar') %></div>

    <div class="content">
        <h1>My Books</h1>
        <div id="loading" class="loading">Loading books...</div>

        <table id="booksTable" style="display: none;">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>ISBN</th>
                    <th>Author</th>
                    <th>Publisher</th>
                    <th>Publication</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be inserted here -->
            </tbody>
        </table>

        <div id="error" class="error" style="display: none;">Failed to load books. Please try again later.</div>
    </div>

    <%- include('../modals/edit_book') %>

    <script>
        function fillTable() {
            try {
                const books = <%- JSON.stringify(books) %>;
                console.log("get books");

                if (typeof books !== "object") {
                    throw new Error('Expected books to be an object');
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('booksTable').style.display = 'table';

                const tableBody = document.querySelector('#booksTable tbody');
                tableBody.innerHTML = '';

                const viewRows = createViewRows(books);

                length = viewRows.length;
                if (length === 0) {
                    document.getElementById('loading').innerHTML = 'No books found.';
                    return;
                }

                for (i = 0; i < length; i++) {
                    tableBody.appendChild(viewRows[i]);
                }

                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                console.error('Error fetching books:', error);
            }
        }

        function createViewRows(books) {
            const rows = [];

            Object.keys(books).forEach(id => {
                    const book = books[id];
            
                    const row = document.createElement('tr');  
                    row.id = 'views_' + id;

                        // title columns
                    const titleCell = document.createElement('td');
                    const titleLink = document.createElement('a');
                    titleLink.textContent = book.title;
                    titleLink.href = `/get/book?book_id=${id}`;
                    titleCell.appendChild(titleLink);

                        // isbn columns
                    const isbnCell = document.createElement('td');
                    isbnCell.textContent = book.isbn;

                        // authors columns
                    const authorCell = document.createElement('td');
                    book.authors.forEach((author, index) => {
                        const authorLink = document.createElement('a');
                        authorLink.textContent = author.name;
                        authorLink.href= `author?auth_id=${encodeURIComponent(author.id)}`;

                        if (index > 0) {
                            authorCell.appendChild(document.createTextNode(', '));
                        }

                        authorCell.appendChild(authorLink);
                    });

                        // publisher columns
                    const publisherCell = document.createElement('td');
                    publisherCell.textContent = book.publisher.name === 'Unknown' ? '' : book.publisher.name;

                        // publication columns
                    const publicationCell = document.createElement('td');
                    publicationCell.textContent = book.publication === 'Unknown' ? '' :  book.publication;

                        // button columns
                    const actionCell = document.createElement('td');

                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('delete-btn');
                    deleteButton.textContent = 'Remve from Library';
                    deleteButton.onclick = () => deleteBook(id);

                    const trashIcon = document.createElement('span');
                    trashIcon.classList.add('material-icons');
                    trashIcon.textContent = 'delete';
                    deleteButton.prepend(trashIcon);

                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.type = 'button';
                    editButton.addEventListener('click', function() {
                        openModal(book);
                    })

                    actionCell.appendChild(deleteButton);
                    actionCell.appendChild(editButton);

                    row.appendChild(titleCell);
                    row.appendChild(isbnCell);
                    row.appendChild(authorCell);
                    row.appendChild(publisherCell);
                    row.appendChild(publicationCell);
                    row.appendChild(actionCell);

                    rows.push(row);
                });

            return rows;
        }

        function openModal(book) {
            const modal = document.getElementById('edit-book-modal');
            const overlay = document.getElementById('modal-overlay');
            console.log(book.title);
           // Prefill the modal form fields
            modal.querySelector('#book_id').value = book.id;

            // Title
            modal.querySelector('#title_input').value = book.title || '';
            modal.querySelector('#title_hidden').value = book.title || '';

            // ISBN
            modal.querySelector('#isbn_input').value = book.isbn || '';
            modal.querySelector('#isbn_hidden').value = book.isbn || '';

            // Availability
            modal.querySelector('#availability_input').value = book.availability || 'public';
            modal.querySelector('#availability_hidden').value = book.availability || 'public';

            // Authors
            const authors = book.authors.map(author => author.name).join(', ');
            modal.querySelector('#authors_input').value = authors || '';
            modal.querySelector('#authors_hidden').value = authors || '';

            // Publisher
            modal.querySelector('#publisher_input').value = book.publisher.name || '';
            modal.querySelector('#publisher_hidden').value = book.publisher.name || '';

            // Publication Year
            modal.querySelector('#publication_input').value = book.publication || '';
            modal.querySelector('#publication_hidden').value = book.publication || '';
            
            // Show the modal and overlay
            modal.style.display = 'block';
            overlay.style.display = 'block';
        }

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById('edit-book-modal');
            const overlay = document.getElementById('modal-overlay');
            
            modal.style.display = 'none';
            overlay.style.display = 'none';
        }

        function toggleForm(id) {
            const view = document.getElementById('views_' + id);
            const form = document.getElementById('form_' + id);

            if (form.style.display === 'none') {
                // Show the form row and hide the view row
                form.style.display = 'table-row';
                view.style.display = 'none';
            } else {
                // Hide the form row and show the view row
                form.style.display = 'none';
                view.style.display = 'table-row';
            }
        }

        async function submitRow(id) {

        }

        // Function to delete a book
        async function deleteBook(book_id) {
            try {
                const response = await fetch(`/remove/from_library?book_id=${book_id}`, {
                    method: 'DELETE',
                }); 

                console.log(response);
                const result = await response.json();
                console.log(result);

                if (!response.ok) {
                    throw new Error(`Failed to delete book. Status: ${response.status}`);
                }

                console.log("attempting to fill table");
                // Refresh the book list after successful deletion
                window.location.href = '/';
            } catch (error) {
                console.error('Error deleting book:', error);
                alert('Failed to delete the book. Please try again.');
            }
        }

        fillTable();
    </script>

</body>
</html>
