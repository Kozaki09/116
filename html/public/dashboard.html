<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/general.css"> <!-- General styles -->
    <link rel="stylesheet" href="/css/dashboard.css"> <!-- Specific styles for dashboard page -->
    <link rel="stylesheet" href="/css/sidebar.css"> <!-- Specific styles for login/create page -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="content">
        <h1>My Books</h1>
        <div id="loading" class="loading">Loading books...</div>

        <table id="booksTable" style="display: none;">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be inserted here -->
            </tbody>
        </table>

        <div id="error" class="error" style="display: none;">Failed to load books. Please try again later.</div>
    </div>

    <script>
        // Function to load the sidebar dynamically
        async function loadSidebar() {
            try {
                const response = await fetch('/public/sidebar.html');
                const sidebarHTML = await response.text();

                // Insert sidebar HTML into the container
                document.getElementById('sidebar-container').innerHTML = sidebarHTML;
            } catch (error) {
                console.error('Error loading the sidebar:', error);
            }
        }

        // Function to fetch books from the API
        async function fetchBooks() {
            try {
                const response = await fetch('/get/my_library');
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch data. Status: ${response.status}`);
                }
                
                const books = await response.json();

                if (!Array.isArray(books)) {
                    throw new Error('Expected books to be an array.');
                }

                // Hide loading and show table
                document.getElementById('loading').style.display = 'none';
                document.getElementById('booksTable').style.display = 'table';

                // Get the table body and clear any previous rows
                const tableBody = document.querySelector('#booksTable tbody');
                tableBody.innerHTML = '';

                // Insert rows into the table
                books.forEach(book => {
                    const row = document.createElement('tr');

                    const titleCell = document.createElement('td');
                    const titleLink = document.createElement('a');
                    titleLink.textContent = book.title;
                    titleLink.href = `/get/book?book_id=${book.id}`;
                    titleCell.appendChild(titleLink);

                    const authorCell = document.createElement('td');
                    const authorlink = document.createElement('a');
                    authorlink.textContent = book.auth_name;
                    authorlink.href = `author?auth_name=${book.auth_name}`;
                    authorCell.append(authorlink);

                    const actionCell = document.createElement('td');

                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => deleteBook(book.id);

                    const trashIcon = document.createElement('span');
                    trashIcon.classList.add('material-icons');
                    trashIcon.textContent = 'delete';

                    deleteButton.prepend(trashIcon);

                    actionCell.appendChild(deleteButton);

                    row.appendChild(titleCell);
                    row.appendChild(authorCell);
                    row.appendChild(actionCell);

                    tableBody.appendChild(row);
                });
            } catch (error) {
                // Handle any errors
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                console.error('Error fetching books:', error);
            }
        }

        // Function to delete a book
        async function deleteBook(book_id) {
            try {
                const response = await fetch(`/remove/from_library?book_id=${book_id}`, {
                    method: 'DELETE',
                }); 

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(`Failed to delete book. Status: ${response.status}`);
                }

                // Refresh the book list after successful deletion
                fetchBooks();
            } catch (error) {
                console.error('Error deleting book:', error);
                alert('Failed to delete the book. Please try again.');
            }
        }

        // Call the functions to load the sidebar and fetch books when the page is loaded
        loadSidebar();
        fetchBooks();
    </script>

</body>
</html>
